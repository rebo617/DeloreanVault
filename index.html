<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeLorean Vault Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f2f2f7;
            padding: 20px;
            line-height: 1.4;
        }

        .app {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .dashboard h2 {
            margin-bottom: 25px;
            font-size: 26px;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            position: relative;
            z-index: 2;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px 18px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .summary-card .icon {
            font-size: 32px;
            margin-bottom: 10px;
            display: block;
        }

        .summary-card h3 {
            margin-bottom: 10px;
            font-size: 11px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .summary-card .value {
            font-size: 22px;
            font-weight: 700;
        }

        .controls {
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-container {
            flex: 1;
            max-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px 10px 40px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 16px;
        }

        .btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #8E8E93;
        }

        .btn-secondary:hover {
            background: #6c757d;
        }

        .btn-success {
            background: #34C759;
        }

        .btn-danger {
            background: #FF3B30;
            padding: 8px 12px;
            font-size: 12px;
        }

        .entries-list {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .entries-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .entry-card {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .entry-card:hover {
            background: #f8f9fa;
        }

        .entry-card:last-child {
            border-bottom: none;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .entry-title {
            flex: 1;
        }

        .entry-date-header {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 4px;
        }

        .item-name {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }

        .entry-actions {
            flex-shrink: 0;
            margin-left: 15px;
            display: flex;
            gap: 8px;
        }

        .edit-btn {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-btn:hover {
            background: #e0a800;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .financial-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007AFF;
        }

        .cost-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .cost-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .cost-label {
            font-size: 10px;
            text-transform: uppercase;
            color: #6c757d;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .cost-value {
            font-size: 16px;
            font-weight: 700;
            font-family: monospace;
            color: #212529;
        }

        .sale-value {
            color: #28a745;
        }

        .profit-info {
            text-align: right;
        }

        .profit-amount {
            font-size: 18px;
            font-weight: 700;
            font-family: monospace;
            margin-bottom: 2px;
        }

        .profit-positive { color: #28a745; }
        .profit-negative { color: #dc3545; }
        .profit-zero { color: #6c757d; }

        .cashback-info {
            font-size: 11px;
            color: #17a2b8;
            font-weight: 500;
        }

        /* Details Toggle Button */
        .details-toggle {
            background: #e9ecef;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .details-toggle:hover {
            background: #dee2e6;
        }

        .toggle-icon {
            transition: transform 0.2s ease;
        }

        .toggle-icon.expanded {
            transform: rotate(90deg);
        }

        /* Entry Details - Initially Hidden */
        .entry-details {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 12px;
            animation: slideDown 0.3s ease;
        }

        .entry-details.visible {
            display: grid;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detail-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }

        .detail-label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 500;
        }

        .detail-value {
            font-size: 13px;
            color: #212529;
            font-weight: 600;
        }

        .card-chip {
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            color: #495057;
        }

        .tracking-section {
            margin-top: 8px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
        }

        .tracking-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }

        .tracking-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 10px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #17a2b8;
        }

        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tracking-label {
            font-size: 11px;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tracking-status {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 500;
            color: #6c757d;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-none { background: #6c757d; }
        .status-pending { background: #ffc107; }
        .status-shipped { background: #17a2b8; }
        .status-delivered { background: #28a745; }

        .tracking-number {
            font-family: monospace;
            color: #007AFF;
            text-decoration: none;
            font-weight: 500;
            font-size: 12px;
            word-break: break-all;
            cursor: pointer;
        }

        .tracking-number:hover {
            text-decoration: underline;
        }

        .tracking-date {
            font-size: 11px;
            color: #6c757d;
            margin-top: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .entry-form {
            background: white;
            border: 2px solid #007AFF;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1);
        }

        .entry-form h3 {
            color: #007AFF;
            margin-bottom: 20px;
            font-size: 18px;
        }

        /* Tab Navigation */
        .form-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .tab-button.active {
            color: #007AFF;
            border-bottom-color: #007AFF;
        }

        .tab-button:hover {
            color: #007AFF;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Email Parser Styles */
        .email-parser {
            margin-bottom: 20px;
        }

        .email-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.4;
            resize: vertical;
            transition: all 0.2s ease;
        }

        .email-textarea:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .parse-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .parse-btn:hover {
            background: #218838;
        }

        .parse-result {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            display: none;
        }

        .parse-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .parse-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .extracted-data {
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input, .form-select {
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
            min-height: 42px;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .form-input:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .outgoing-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
            opacity: 0.4;
            transition: opacity 0.3s ease;
        }

        .outgoing-section.visible {
            opacity: 1;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .card-list {
            margin: 20px 0;
        }

        .card-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .hidden {
            display: none !important;
        }

        /* Login Modal Styles */
        .login-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .login-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .login-content h2 {
            color: #007AFF;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .login-btn {
            width: 100%;
            background: #007AFF;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .login-btn:hover {
            background: #0056b3;
        }

        .login-error {
            color: #dc3545;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }

        .app-container {
            display: none;
        }

        .app-container.authenticated {
            display: block;
        }

        .logout-btn {
            background: #8E8E93;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            position: absolute;
            top: 30px;
            right: 30px;
            z-index: 100;
        }

        .logout-btn:hover {
            background: #6c757d;
        }

        .app {
            position: relative;
        }

        @media (max-width: 768px) {
            .entry-details {
                grid-template-columns: 1fr;
            }

            .cost-info {
                flex-wrap: wrap;
                gap: 10px;
            }

            .financial-summary {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .profit-info {
                text-align: center;
            }

            .modal-content {
                width: 95%;
                margin: 2% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-content">
            <h2>🚗 DeLorean Vault Access</h2>
            <p style="color: #6c757d; margin-bottom: 25px;">Enter password to access your tracking dashboard</p>
            <input type="password" id="passwordInput" class="login-input" placeholder="Enter password" onkeyup="handlePasswordKeyup(event)">
            <button class="login-btn" onclick="attemptLogin()">🔓 Access Dashboard</button>
            <div id="loginError" class="login-error">❌ Incorrect password. Please try again.</div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container">
    <div class="app">
        <!-- Logout Button -->
        <button class="logout-btn" onclick="logout()">🚪 Logout</button>
        
        <div class="dashboard">
            <h2>🚗 DeLorean Vault Tracking App</h2>
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="icon">💰</div>
                    <h3>Total Purchases</h3>
                    <div class="value" id="totalPurchases">$0.00</div>
                </div>
                <div class="summary-card">
                    <div class="icon">💳</div>
                    <h3>Total Cash Back</h3>
                    <div class="value" id="totalCashBack">$0.00</div>
                </div>
                <div class="summary-card">
                    <div class="icon">💵</div>
                    <h3>Total Revenue</h3>
                    <div class="value" id="totalRevenue">$0.00</div>
                </div>
                <div class="summary-card">
                    <div class="icon">📈</div>
                    <h3>Net Profit</h3>
                    <div class="value" id="netProfit">$0.00</div>
                </div>
                <div class="summary-card">
                    <div class="icon">📦</div>
                    <h3>Incoming Packages</h3>
                    <div class="value" id="incomingPackages">0</div>
                </div>
                <div class="summary-card">
                    <div class="icon">🚚</div>
                    <h3>Outgoing Packages</h3>
                    <div class="value" id="outgoingPackages">0</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="search-container">
                <div class="search-icon">🔍</div>
                <input type="text" id="searchInput" class="search-input" placeholder="Search entries..." onkeyup="filterEntries()">
            </div>
            <button class="btn" onclick="openEntryModal()">➕ Add Purchase</button>
            <button class="btn btn-secondary" onclick="openCardModal()">💳 Manage Credit Cards</button>
            <button class="btn btn-success" onclick="exportCSV()">📊 Export CSV</button>
            <button class="btn btn-secondary" onclick="document.getElementById('csvFile').click()">📁 Import CSV</button>
            <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="importCSV(event)">
        </div>

        <div class="entries-list">
            <div class="entries-header">
                <span>📋 Purchase History</span>
                <span id="entriesCount">0 entries</span>
            </div>
            <div id="entriesContainer">
                <div class="empty-state">
                    <div class="icon">📦</div>
                    <h3>No purchases yet</h3>
                    <p>Add your first purchase above to get started!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Entry Modal -->
    <div id="entryModal" class="modal">
        <div class="modal-content">
            <div class="entry-form">
                <h3 id="entryModalTitle">➕ Add New Purchase</h3>
                
                <!-- Tab Navigation -->
                <div class="form-tabs">
                    <button class="tab-button active" onclick="switchTab('manual')">✏️ Manual Entry</button>
                    <button class="tab-button" onclick="switchTab('email')">📧 Parse Email</button>
                </div>

                <!-- Email Parser Tab -->
                <div id="emailTab" class="tab-content">
                    <div class="email-parser">
                        <label class="form-label">Paste Email Receipt Content:</label>
                        <textarea id="emailContent" class="email-textarea" placeholder="Paste your email receipt here...&#10;&#10;Example:&#10;Thank you for your order!&#10;iPhone 15 Pro Max 256GB - Natural Titanium&#10;Qty: 1 - $1,199.99&#10;&#10;Order Total: $1,199.99&#10;Charged to: Chase Sapphire Reserve ending in 1234"></textarea>
                        <button class="parse-btn" onclick="parseEmailContent()">🔍 Extract Data</button>
                        <div id="parseResult" class="parse-result"></div>
                    </div>
                </div>

                <!-- Manual Entry Tab -->
                <div id="manualTab" class="tab-content active">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="entryDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Item</label>
                        <input type="text" id="entryItem" class="form-input" placeholder="Item description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Purchase Card</label>
                        <select id="entryCard" class="form-select" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="entryAmount" class="form-input" placeholder="0.00" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Shipping Cost</label>
                        <input type="number" id="entryShippingCost" class="form-input" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Shipping Card</label>
                        <select id="entryShippingCard" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Incoming Tracking</label>
                        <input type="text" id="entryIncomingTracking" class="form-input" placeholder="Tracking #">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Resold</label>
                        <select id="entryResold" class="form-select" onchange="toggleOutgoingSection()">
                            <option value="false">No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sale Price</label>
                        <input type="number" id="entrySalePrice" class="form-input" placeholder="0.00" step="0.01" min="0" disabled>
                    </div>
                </div>
                
                <div class="outgoing-section" id="outgoingSection">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Outgoing Tracking</label>
                            <input type="text" id="entryOutgoingTracking" class="form-input" placeholder="Tracking #">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Outgoing Ship Date</label>
                            <input type="date" id="entryOutgoingDate" class="form-input">
                        </div>
                    </div>
                </div>
                </div>

                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeEntryModal()">❌ Cancel</button>
                    <button class="btn btn-secondary" onclick="clearForm()">🗑️ Clear</button>
                    <button class="btn" id="submitBtn" onclick="addEntry()">✅ Add Entry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Modal -->
    <div id="cardModal" class="modal">
        <div class="modal-content">
            <h2>💳 Manage Credit Cards</h2>
            <div class="card-list" id="cardList"></div>
            <h3>Add New Credit Card</h3>
            <div class="form-group">
                <label class="form-label">Card Name:</label>
                <input type="text" id="newCardName" class="form-input" placeholder="e.g., Capital One Venture">
            </div>
            <div class="form-group">
                <label class="form-label">Cash Back Rate (%):</label>
                <input type="number" id="newCardRate" class="form-input" step="0.01" min="0" max="100" placeholder="e.g., 2.5">
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 25px;">
                <button class="btn" onclick="addNewCard()">✅ Add Card</button>
                <button class="btn btn-secondary" onclick="closeCardModal()">❌ Close</button>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Authentication variables
        const CORRECT_PASSWORD = '24Florence!';
        let isAuthenticated = false;
        let inactivityTimer = null;
        const INACTIVITY_TIMEOUT = 15 * 60 * 1000; // 15 minutes in milliseconds

        // Authentication functions
        function attemptLogin() {
            const passwordInput = document.getElementById('passwordInput');
            const loginError = document.getElementById('loginError');
            const enteredPassword = passwordInput.value;

            if (enteredPassword === CORRECT_PASSWORD) {
                isAuthenticated = true;
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('appContainer').classList.add('authenticated');
                passwordInput.value = ''; // Clear password
                loginError.style.display = 'none';
                
                // Start inactivity timer
                startInactivityTimer();
                setupActivityListeners();
            } else {
                loginError.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
                
                // Add shake animation
                passwordInput.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    passwordInput.style.animation = '';
                }, 500);
            }
        }

        function handlePasswordKeyup(event) {
            if (event.key === 'Enter') {
                attemptLogin();
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                performLogout();
            }
        }

        function performLogout() {
            isAuthenticated = false;
            clearInactivityTimer();
            removeActivityListeners();
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('authenticated');
            document.getElementById('passwordInput').focus();
        }

        // Auto-logout functionality
        function startInactivityTimer() {
            clearInactivityTimer();
            inactivityTimer = setTimeout(() => {
                alert('⏰ You have been logged out due to 15 minutes of inactivity.');
                performLogout();
            }, INACTIVITY_TIMEOUT);
        }

        function clearInactivityTimer() {
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
        }

        function resetInactivityTimer() {
            if (isAuthenticated) {
                startInactivityTimer();
            }
        }

        function setupActivityListeners() {
            // Listen for various user activities
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            events.forEach(event => {
                document.addEventListener(event, resetInactivityTimer, true);
            });
        }

        function removeActivityListeners() {
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            events.forEach(event => {
                document.removeEventListener(event, resetInactivityTimer, true);
            });
        }

        // Add shake animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);

        // Global variables
        let cards = {
            'Chase Reserve': 0.01,
            'Wells Fargo': 0.02,
            'Farmers Credit Union': 0.025
        };

        let allEntries = []; // Store all entries
        let filteredEntries = []; // Store filtered entries for display
        let entryCounter = 0;
        let isEditMode = false;
        let editingEntryId = null;

        // Sample data for testing
        const sampleData = [
            {
                date: '2024-01-15',
                item: 'iPhone 15 Pro',
                card: 'Chase Reserve',
                amount: 999.00,
                shippingCost: 12.99,
                shippingCard: 'Wells Fargo',
                incomingTracking: '1Z999AA1234567890',
                resold: true,
                salePrice: 1150.00,
                outgoingTracking: '1Z999BB9876543210',
                outgoingDate: '2024-01-25'
            },
            {
                date: '2024-01-20',
                item: 'Nike Air Jordan Retro',
                card: 'Wells Fargo',
                amount: 180.00,
                shippingCost: 8.50,
                shippingCard: 'Wells Fargo',
                incomingTracking: '1Z888CC1122334455',
                resold: true,
                salePrice: 220.00,
                outgoingTracking: '1Z777DD5566778899',
                outgoingDate: '2024-01-30'
            },
            {
                date: '2024-02-15',
                item: 'Apple Watch Series 9',
                card: 'Wells Fargo',
                amount: 429.00,
                shippingCost: 0,
                shippingCard: 'Wells Fargo',
                incomingTracking: '1Z666EE9988776655',
                resold: false,
                salePrice: 0,
                outgoingTracking: '',
                outgoingDate: ''
            }
        ];

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            return `${month}-${day}-${year}`;
        }

        function formatCurrency(amount) {
            return '$' + Number(amount).toFixed(2);
        }

        function getTrackingStatus(trackingNumber) {
            if (!trackingNumber || trackingNumber.trim() === '') {
                return 'none';
            }
            
            let hash = 0;
            for (let i = 0; i < trackingNumber.length; i++) {
                hash = ((hash << 5) - hash) + trackingNumber.charCodeAt(i);
                hash = hash & hash;
            }
            
            const mod = Math.abs(hash) % 100;
            if (mod < 30) return 'pending';
            if (mod < 70) return 'shipped';
            return 'delivered';
        }

        function getStatusText(status) {
            switch(status) {
                case 'none': return 'unknown';
                case 'pending': return 'pending';
                case 'shipped': return 'in transit';
                case 'delivered': return 'delivered';
                default: return 'unknown';
            }
        }

        function calculateMetrics(entry) {
            const amount = parseFloat(entry.amount) || 0;
            const shippingCost = parseFloat(entry.shippingCost) || 0;
            const salePrice = parseFloat(entry.salePrice) || 0;
            
            // Cash back calculations
            const purchaseCashBackRate = cards[entry.card] || 0;
            const purchaseCashBack = amount * purchaseCashBackRate;
            
            const shippingCashBackRate = shippingCost > 0 ? (cards[entry.shippingCard] || 0) : 0;
            const shippingCashBack = shippingCost * shippingCashBackRate;
            
            const totalCashBack = purchaseCashBack + shippingCashBack;
            
            // Cash profit = sale price - purchase price (not including shipping)
            const cashProfit = entry.resold ? (salePrice - amount) : 0;
            
            // Total profit = cash back + cash profit
            const totalProfit = totalCashBack + cashProfit;
            
            const totalCost = amount + shippingCost;
            
            return { 
                cashBack: totalCashBack,
                cashProfit: cashProfit,
                profit: totalProfit,
                totalCost: totalCost
            };
        }

        // Modal functions
        function openEntryModal() {
            document.getElementById('entryModal').style.display = 'block';
            populateCardSelect();
            // Reset to manual tab
            switchTab('manual');
        }

        function closeEntryModal() {
            document.getElementById('entryModal').style.display = 'none';
            clearForm();
            // Clear email content
            document.getElementById('emailContent').value = '';
            document.getElementById('parseResult').style.display = 'none';
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.getElementById('manualTab').classList.remove('active');
            document.getElementById('emailTab').classList.remove('active');
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab and activate button
            if (tabName === 'manual') {
                document.getElementById('manualTab').classList.add('active');
                tabButtons[0].classList.add('active');
            } else if (tabName === 'email') {
                document.getElementById('emailTab').classList.add('active');
                tabButtons[1].classList.add('active');
            }
        }

        // Email parsing functionality
        function parseEmailContent() {
            const emailText = document.getElementById('emailContent').value.trim();
            const resultDiv = document.getElementById('parseResult');
            
            if (!emailText) {
                showParseResult('error', 'Please paste email content first.');
                return;
            }

            try {
                const extractedData = extractPurchaseData(emailText);
                
                if (!extractedData.item && !extractedData.amount) {
                    showParseResult('error', 'Could not extract purchase data. Please check the email format or use manual entry.');
                    return;
                }

                // Auto-populate form fields
                populateFormFromEmailData(extractedData);
                
                // Show success message
                let successMsg = '✅ Data extracted successfully!\n';
                if (extractedData.item) successMsg += `Item: ${extractedData.item}\n`;
                if (extractedData.amount) successMsg += `Amount: ${extractedData.amount}\n`;
                if (extractedData.card) successMsg += `Card: ${extractedData.card}\n`;
                if (extractedData.tracking) successMsg += `Tracking: ${extractedData.tracking}\n`;
                
                showParseResult('success', successMsg);
                
                // Switch to manual tab to review
                setTimeout(() => {
                    switchTab('manual');
                }, 1500);
                
            } catch (error) {
                showParseResult('error', 'Error parsing email content: ' + error.message);
            }
        }

        function extractPurchaseData(emailText) {
            const data = {
                item: null,
                amount: null,
                card: null,
                tracking: null
            };

            // Clean up the text
            const text = emailText.toLowerCase();
            
            // Extract total amount - look for various patterns
            const amountPatterns = [
                /(?:total|grand total|order total|amount charged)[:\s]*\$?([\d,]+\.?\d*)/i,
                /\$?([\d,]+\.?\d*)\s*(?:total|charged|paid)/i,
                /(?:you (?:paid|were charged|spent))[:\s]*\$?([\d,]+\.?\d*)/i
            ];
            
            for (const pattern of amountPatterns) {
                const match = emailText.match(pattern);
                if (match) {
                    const amount = parseFloat(match[1].replace(/,/g, ''));
                    if (amount > 0 && amount < 100000) { // Reasonable bounds
                        data.amount = amount;
                        break;
                    }
                }
            }

            // Extract item description - look for product names
            const itemPatterns = [
                /(?:item|product|description)[:\s]*([^\n\r]+)/i,
                /(?:you (?:ordered|bought|purchased))[:\s]*([^\n\r]+)/i,
                /(?:qty[:\s]*\d+[:\s]*-?\s*)([^\n\r$]+)/i
            ];
            
            // Also look for common product patterns
            const productPatterns = [
                /(iphone|ipad|macbook|airpods)[^,\n\r$]*/i,
                /(nike|adidas|jordan)[^,\n\r$]*/i,
                /(apple|samsung|sony)[^,\n\r$]*/i,
                /([a-z\s]+(?:pro|max|plus|mini|air|edition))[^,\n\r$]*/i
            ];

            for (const pattern of itemPatterns.concat(productPatterns)) {
                const match = emailText.match(pattern);
                if (match && match[1]) {
                    let item = match[1].trim();
                    // Clean up common artifacts
                    item = item.replace(/[-–]\s*\$.*$/, ''); // Remove price suffix
                    item = item.replace(/\s*qty[:\s]*\d+/i, ''); // Remove quantity
                    item = item.replace(/^\s*-\s*/, ''); // Remove leading dash
                    if (item.length > 5 && item.length < 100) {
                        data.item = item;
                        break;
                    }
                }
            }

            // Extract card information
            const cardPatterns = [
                /(?:charged to|paid with|using)[:\s]*([^,\n\r]+(?:visa|mastercard|amex|discover|chase|wells fargo|capital one|citi)[^,\n\r]*)/i,
                /([^,\n\r]*(?:chase|wells fargo|capital one|citi|visa|mastercard|amex|discover)[^,\n\r]*)/i
            ];
            
            for (const pattern of cardPatterns) {
                const match = emailText.match(pattern);
                if (match && match[1]) {
                    const cardText = match[1].trim();
                    // Try to match against existing cards
                    const matchedCard = findMatchingCard(cardText);
                    if (matchedCard) {
                        data.card = matchedCard;
                        break;
                    }
                }
            }

            // Extract tracking number
            const trackingPatterns = [
                /tracking[\s#:]*([a-z0-9]{10,})/i,
                /(?:ups|fedex|usps)[\s#:]*([a-z0-9]{10,})/i,
                /(1z[a-z0-9]{16})/i
            ];
            
            for (const pattern of trackingPatterns) {
                const match = emailText.match(pattern);
                if (match && match[1]) {
                    data.tracking = match[1].trim();
                    break;
                }
            }

            return data;
        }

        function findMatchingCard(cardText) {
            const cardTextLower = cardText.toLowerCase();
            
            // Check each stored card for partial matches
            for (const cardName in cards) {
                const cardNameLower = cardName.toLowerCase();
                
                // Check for partial name matches
                const cardWords = cardNameLower.split(/\s+/);
                let matchScore = 0;
                
                for (const word of cardWords) {
                    if (word.length > 2 && cardTextLower.includes(word)) {
                        matchScore++;
                    }
                }
                
                // If we match at least half the words, consider it a match
                if (matchScore >= Math.ceil(cardWords.length / 2)) {
                    return cardName;
                }
            }
            
            return null;
        }

        function populateFormFromEmailData(data) {
            if (data.item) {
                document.getElementById('entryItem').value = data.item;
            }
            
            if (data.amount) {
                document.getElementById('entryAmount').value = data.amount;
            }
            
            if (data.card) {
                const cardSelect = document.getElementById('entryCard');
                const shippingCardSelect = document.getElementById('entryShippingCard');
                for (let i = 0; i < cardSelect.options.length; i++) {
                    if (cardSelect.options[i].text.includes(data.card)) {
                        cardSelect.selectedIndex = i;
                        shippingCardSelect.selectedIndex = i;
                        break;
                    }
                }
            }
            
            if (data.tracking) {
                document.getElementById('entryIncomingTracking').value = data.tracking;
            }
        }

        function showParseResult(type, message) {
            const resultDiv = document.getElementById('parseResult');
            resultDiv.className = `parse-result parse-${type}`;
            resultDiv.innerHTML = message.replace(/\n/g, '<br>');
            resultDiv.style.display = 'block';
        }

        // Form functions
        function populateCardSelect() {
            const select = document.getElementById('entryCard');
            const shippingSelect = document.getElementById('entryShippingCard');
            let options = '';
            for (const cardName in cards) {
                const rate = cards[cardName];
                const percentage = (rate * 100).toFixed(1);
                options += `<option value="${cardName}">${cardName} (${percentage}%)</option>`;
            }
            select.innerHTML = options;
            shippingSelect.innerHTML = options;
        }

        function toggleOutgoingSection() {
            const resold = document.getElementById('entryResold').value === 'true';
            const outgoingSection = document.getElementById('outgoingSection');
            const salePriceInput = document.getElementById('entrySalePrice');
            
            if (resold) {
                outgoingSection.classList.add('visible');
                salePriceInput.disabled = false;
            } else {
                outgoingSection.classList.remove('visible');
                salePriceInput.disabled = true;
                salePriceInput.value = '';
                document.getElementById('entryOutgoingTracking').value = '';
                document.getElementById('entryOutgoingDate').value = '';
            }
        }

        function clearForm() {
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('entryItem').value = '';
            document.getElementById('entryAmount').value = '';
            document.getElementById('entryShippingCost').value = '';
            document.getElementById('entryIncomingTracking').value = '';
            document.getElementById('entryResold').value = 'false';
            document.getElementById('entrySalePrice').value = '';
            document.getElementById('entryOutgoingTracking').value = '';
            document.getElementById('entryOutgoingDate').value = '';
            
            const cardSelect = document.getElementById('entryCard');
            const shippingCardSelect = document.getElementById('entryShippingCard');
            if (cardSelect.options.length > 0) {
                cardSelect.selectedIndex = 0;
                shippingCardSelect.selectedIndex = 0;
            }
            
            toggleOutgoingSection();
            
            // Reset form to add mode
            isEditMode = false;
            editingEntryId = null;
            const submitBtn = document.getElementById('submitBtn');
            const modalTitle = document.getElementById('entryModalTitle');
            submitBtn.textContent = '✅ Add Entry';
            modalTitle.textContent = '➕ Add New Purchase';
            submitBtn.onclick = addEntry;
        }

        function addEntry() {
            const date = document.getElementById('entryDate').value;
            const item = document.getElementById('entryItem').value.trim();
            const card = document.getElementById('entryCard').value;
            const amount = parseFloat(document.getElementById('entryAmount').value) || 0;
            const shippingCost = parseFloat(document.getElementById('entryShippingCost').value) || 0;
            const shippingCard = document.getElementById('entryShippingCard').value;
            const incomingTracking = document.getElementById('entryIncomingTracking').value.trim();
            const resold = document.getElementById('entryResold').value === 'true';
            const salePrice = parseFloat(document.getElementById('entrySalePrice').value) || 0;
            const outgoingTracking = document.getElementById('entryOutgoingTracking').value.trim();
            const outgoingDate = document.getElementById('entryOutgoingDate').value;

            if (!item) {
                alert('Please enter an item name.');
                return;
            }

            if (amount <= 0) {
                alert('Please enter a valid purchase amount.');
                return;
            }

            const entry = {
                id: ++entryCounter,
                date: date,
                item: item,
                card: card,
                amount: amount,
                shippingCost: shippingCost,
                shippingCard: shippingCard,
                incomingTracking: incomingTracking,
                resold: resold,
                salePrice: resold ? salePrice : 0,
                outgoingTracking: resold ? outgoingTracking : '',
                outgoingDate: resold ? outgoingDate : ''
            };

            if (isEditMode) {
                // Update existing entry
                const entryIndex = allEntries.findIndex(e => e.id === editingEntryId);
                if (entryIndex !== -1) {
                    entry.id = editingEntryId; // Keep the same ID
                    allEntries[entryIndex] = entry;
                }
            } else {
                // Add new entry
                allEntries.unshift(entry);
            }
            
            closeEntryModal();
            filterEntries();
            updateDashboard();
        }

        function startEdit(entryId) {
            // Find the entry
            const entry = allEntries.find(e => e.id === entryId);
            if (!entry) return;

            // Open modal and populate the form with entry data
            openEntryModal();
            
            document.getElementById('entryDate').value = entry.date;
            document.getElementById('entryItem').value = entry.item;
            document.getElementById('entryCard').value = entry.card;
            document.getElementById('entryAmount').value = entry.amount;
            document.getElementById('entryShippingCost').value = entry.shippingCost || '';
            document.getElementById('entryShippingCard').value = entry.shippingCard || entry.card;
            document.getElementById('entryIncomingTracking').value = entry.incomingTracking || '';
            document.getElementById('entryResold').value = entry.resold ? 'true' : 'false';
            document.getElementById('entrySalePrice').value = entry.resold ? entry.salePrice : '';
            document.getElementById('entryOutgoingTracking').value = entry.outgoingTracking || '';
            document.getElementById('entryOutgoingDate').value = entry.outgoingDate || '';

            // Toggle the outgoing section if needed
            toggleOutgoingSection();

            // Set edit mode
            isEditMode = true;
            editingEntryId = entryId;
            const submitBtn = document.getElementById('submitBtn');
            const modalTitle = document.getElementById('entryModalTitle');
            submitBtn.textContent = '✏️ Update Entry';
            modalTitle.textContent = '✏️ Edit Purchase';
            submitBtn.onclick = addEntry; // Same function handles both add and edit
        }

        function deleteEntry(entryId) {
            if (confirm('Are you sure you want to delete this entry?')) {
                allEntries = allEntries.filter(entry => entry.id !== entryId);
                filterEntries();
                updateDashboard();
            }
        }

        // Details toggle function
        function toggleDetails(entryId) {
            const detailsSection = document.getElementById(`details-${entryId}`);
            const toggleIcon = document.getElementById(`toggle-${entryId}`);
            
            if (detailsSection.classList.contains('visible')) {
                detailsSection.classList.remove('visible');
                toggleIcon.classList.remove('expanded');
            } else {
                detailsSection.classList.add('visible');
                toggleIcon.classList.add('expanded');
            }
        }

        // Search and filter functions
        function filterEntries() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm === '') {
                filteredEntries = allEntries.slice();
            } else {
                filteredEntries = allEntries.filter(entry => {
                    return entry.item.toLowerCase().includes(searchTerm) ||
                           entry.card.toLowerCase().includes(searchTerm) ||
                           (entry.shippingCard && entry.shippingCard.toLowerCase().includes(searchTerm)) ||
                           entry.date.includes(searchTerm) ||
                           (entry.incomingTracking && entry.incomingTracking.toLowerCase().includes(searchTerm)) ||
                           (entry.outgoingTracking && entry.outgoingTracking.toLowerCase().includes(searchTerm));
                });
            }
            
            renderEntries();
        }

        // Render functions
        function renderEntries() {
            const container = document.getElementById('entriesContainer');
            const count = document.getElementById('entriesCount');
            
            count.textContent = filteredEntries.length + ' entries' + (filteredEntries.length !== allEntries.length ? ' (filtered)' : '');

            if (filteredEntries.length === 0) {
                if (allEntries.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="icon">📦</div><h3>No purchases yet</h3><p>Add your first purchase above to get started!</p></div>';
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="icon">🔍</div><h3>No matching entries</h3><p>Try a different search term or clear the search to see all entries.</p></div>';
                }
                return;
            }

            let html = '';

            for (let i = 0; i < filteredEntries.length; i++) {
                const entry = filteredEntries[i];
                const metrics = calculateMetrics(entry);
                const profitClass = metrics.profit > 0 ? 'profit-positive' : metrics.profit < 0 ? 'profit-negative' : 'profit-zero';
                const totalCost = (parseFloat(entry.amount) || 0) + (parseFloat(entry.shippingCost) || 0);
                
                html += '<div class="entry-card">';
                
                // Entry Header - Date as headline, item as subtitle
                html += '<div class="entry-header">';
                html += '<div class="entry-title">';
                html += '<div class="entry-date-header">' + formatDate(entry.date) + '</div>';
                html += '<div class="item-name">' + entry.item + '</div>';
                html += '</div>';
                html += '<div class="entry-actions">';
                html += '<button class="edit-btn" onclick="startEdit(' + entry.id + ')">Edit</button>';
                html += '<button class="delete-btn" onclick="deleteEntry(' + entry.id + ')">Delete</button>';
                html += '</div>';
                html += '</div>';
                
                // Financial Summary Bar
                html += '<div class="financial-summary">';
                html += '<div class="cost-info">';
                
                html += '<div class="cost-item">';
                html += '<div class="cost-label">Total Cost</div>';
                html += '<div class="cost-value">' + formatCurrency(totalCost) + '</div>';
                html += '</div>';
                
                if (entry.resold && entry.salePrice > 0) {
                    html += '<div class="cost-item">';
                    html += '<div class="cost-label">Sale Price</div>';
                    html += '<div class="cost-value sale-value">' + formatCurrency(entry.salePrice) + '</div>';
                    html += '</div>';
                }
                
                html += '<div class="cost-item">';
                html += '<div class="cost-label">Cash Profit</div>';
                html += '<div class="cost-value ' + (entry.resold ? (metrics.cashProfit > 0 ? 'sale-value' : 'profit-negative') : 'profit-zero') + '">' + 
                    formatCurrency(metrics.cashProfit) + '</div>';
                html += '</div>';
                
                html += '<div class="cost-item">';
                html += '<div class="cost-label">Cash Back</div>';
                html += '<div class="cost-value" style="color: #17a2b8;">' + formatCurrency(metrics.cashBack) + '</div>';
                html += '</div>';
                
                html += '</div>';
                
                html += '<div class="profit-info">';
                if (entry.resold) {
                    html += '<div class="profit-amount ' + profitClass + '">' + formatCurrency(metrics.profit) + '</div>';
                    html += '<div class="cashback-info">Total Profit</div>';
                } else {
                    html += '<div class="profit-amount profit-zero">' + formatCurrency(metrics.cashBack) + '</div>';
                    html += '<div class="cashback-info">Rewards Only</div>';
                }
                html += '</div>';
                
                html += '</div>';
                
                // Details Toggle Button
                html += '<button class="details-toggle" onclick="toggleDetails(' + entry.id + ')">';
                html += '<span class="toggle-icon" id="toggle-' + entry.id + '">▶</span>';
                html += 'Show Details';
                html += '</button>';
                
                // Details Grid (Initially Hidden)
                html += '<div class="entry-details" id="details-' + entry.id + '">';
                
                // Purchase Details
                html += '<div class="detail-section">';
                html += '<div class="section-title">Purchase Details</div>';
                
                html += '<div class="detail-row">';
                html += '<div class="detail-label">Purchase Card</div>';
                html += '<div class="detail-value"><span class="card-chip">' + entry.card + '</span></div>';
                html += '</div>';
                
                html += '<div class="detail-row">';
                html += '<div class="detail-label">Item Cost</div>';
                html += '<div class="detail-value">' + formatCurrency(entry.amount) + '</div>';
                html += '</div>';
                
                html += '<div class="detail-row">';
                html += '<div class="detail-label">Shipping Card</div>';
                html += '<div class="detail-value"><span class="card-chip">' + (entry.shippingCard || entry.card) + '</span></div>';
                html += '</div>';
                
                html += '<div class="detail-row">';
                html += '<div class="detail-label">Shipping Cost</div>';
                html += '<div class="detail-value">' + (entry.shippingCost > 0 ? formatCurrency(entry.shippingCost) : '$0.00') + '</div>';
                html += '</div>';
                
                html += '</div>';
                
                // Sale Details
                html += '<div class="detail-section">';
                html += '<div class="section-title">Sale Details</div>';
                
                html += '<div class="detail-row">';
                html += '<div class="detail-label">Status</div>';
                html += '<div class="detail-value">' + (entry.resold ? 'Sold' : 'Not sold') + '</div>';
                html += '</div>';
                
                html += '<div class="detail-row">';
                html += '<div class="detail-label">Sale Price</div>';
                html += '<div class="detail-value">' + (entry.resold ? formatCurrency(entry.salePrice) : '-') + '</div>';
                html += '</div>';
                
                html += '<div class="detail-row">';
                html += '<div class="detail-label">Cash Back Earned</div>';
                html += '<div class="detail-value" style="color: #17a2b8; font-weight: 600;">' + formatCurrency(metrics.cashBack) + '</div>';
                html += '</div>';
                
                if (entry.resold) {
                    html += '<div class="detail-row">';
                    html += '<div class="detail-label">Ship Date</div>';
                    html += '<div class="detail-value">' + (entry.outgoingDate ? formatDate(entry.outgoingDate) : '-') + '</div>';
                    html += '</div>';
                }
                
                html += '</div>';
                
                html += '</div>';
                
                // Tracking Section (only show if there's tracking info or item is resold)
                if (entry.incomingTracking || entry.resold) {
                    html += '<div class="tracking-section">';
                    html += '<div class="tracking-grid">';
                    
                    // Incoming tracking (show for purchases with incoming tracking)
                    if (entry.incomingTracking) {
                        const incomingStatus = getTrackingStatus(entry.incomingTracking);
                        const incomingStatusText = getStatusText(incomingStatus);
                        
                        html += '<div class="tracking-item">';
                        html += '<div class="tracking-header">';
                        html += '<div class="tracking-label">📦 Incoming Package</div>';
                        html += '<div class="tracking-status">';
                        html += '<div class="status-dot status-' + incomingStatus + '"></div>';
                        html += '<span>' + incomingStatusText + '</span>';
                        html += '</div>';
                        html += '</div>';
                        html += '<a class="tracking-number" onclick="trackPackage(\'' + entry.incomingTracking + '\')">' + entry.incomingTracking + '</a>';
                        html += '</div>';
                    }
                    
                    // Outgoing tracking (show for resold items)
                    if (entry.resold) {
                        if (entry.outgoingTracking) {
                            const outgoingStatus = getTrackingStatus(entry.outgoingTracking);
                            const outgoingStatusText = getStatusText(outgoingStatus);
                            
                            html += '<div class="tracking-item">';
                            html += '<div class="tracking-header">';
                            html += '<div class="tracking-label">🚚 Outgoing Package</div>';
                            html += '<div class="tracking-status">';
                            html += '<div class="status-dot status-' + outgoingStatus + '"></div>';
                            html += '<span>' + outgoingStatusText + '</span>';
                            html += '</div>';
                            html += '</div>';
                            html += '<a class="tracking-number" onclick="trackPackage(\'' + entry.outgoingTracking + '\')">' + entry.outgoingTracking + '</a>';
                            if (entry.outgoingDate) {
                                html += '<div class="tracking-date">Shipped: ' + formatDate(entry.outgoingDate) + '</div>';
                            }
                            html += '</div>';
                        } else {
                            // Show placeholder for items that are sold but don't have outgoing tracking yet
                            html += '<div class="tracking-item" style="border-left-color: #ffc107;">';
                            html += '<div class="tracking-header">';
                            html += '<div class="tracking-label">🚚 Outgoing Package</div>';
                            html += '<div class="tracking-status">';
                            html += '<div class="status-dot status-pending"></div>';
                            html += '<span>awaiting shipment</span>';
                            html += '</div>';
                            html += '</div>';
                            html += '<div style="color: #6c757d; font-style: italic;">No tracking number yet</div>';
                            if (entry.outgoingDate) {
                                html += '<div class="tracking-date">Shipped: ' + formatDate(entry.outgoingDate) + '</div>';
                            }
                            html += '</div>';
                        }
                    }
                    
                    html += '</div>';
                    html += '</div>';
                }
                
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function updateDashboard() {
            let totalPurchases = 0;
            let totalCashBack = 0;
            let totalRevenue = 0;
            let incomingPackages = 0;
            let outgoingPackages = 0;

            for (let i = 0; i < allEntries.length; i++) {
                const entry = allEntries[i];
                const amount = parseFloat(entry.amount) || 0;
                const shippingCost = parseFloat(entry.shippingCost) || 0;
                const salePrice = parseFloat(entry.salePrice) || 0;
                const metrics = calculateMetrics(entry);

                totalPurchases += amount + shippingCost;
                totalCashBack += metrics.cashBack;
                totalRevenue += salePrice;

                const incomingStatus = getTrackingStatus(entry.incomingTracking);
                const outgoingStatus = getTrackingStatus(entry.outgoingTracking);

                if (entry.incomingTracking && incomingStatus !== 'delivered') {
                    incomingPackages++;
                }
                if (entry.outgoingTracking && entry.resold && outgoingStatus !== 'delivered') {
                    outgoingPackages++;
                }
            }

            // Net profit = total cash back + total cash profit
            let netProfit = totalCashBack;
            for (let i = 0; i < allEntries.length; i++) {
                const entry = allEntries[i];
                const metrics = calculateMetrics(entry);
                netProfit += metrics.cashProfit;
            }

            document.getElementById('totalPurchases').textContent = formatCurrency(totalPurchases);
            document.getElementById('totalCashBack').textContent = formatCurrency(totalCashBack);
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('netProfit').textContent = formatCurrency(netProfit);
            document.getElementById('incomingPackages').textContent = incomingPackages;
            document.getElementById('outgoingPackages').textContent = outgoingPackages;
        }

        // Utility functions
        function trackPackage(trackingNumber) {
            if (trackingNumber && trackingNumber.trim()) {
                window.open('https://www.google.com/search?q=' + encodeURIComponent(trackingNumber + ' tracking'), '_blank');
            }
        }

        // Card management functions
        function openCardModal() {
            document.getElementById('cardModal').style.display = 'block';
            renderCardList();
        }

        function closeCardModal() {
            document.getElementById('cardModal').style.display = 'none';
            document.getElementById('newCardName').value = '';
            document.getElementById('newCardRate').value = '';
        }

        function renderCardList() {
            const cardList = document.getElementById('cardList');
            let html = '';
            for (const cardName in cards) {
                const rate = cards[cardName];
                html += '<div class="card-item">';
                html += '<span><strong>' + cardName + '</strong> - ' + (rate * 100).toFixed(1) + '% Cash Back</span>';
                html += '<button class="btn btn-danger" onclick="deleteCard(\'' + cardName + '\')">Delete</button>';
                html += '</div>';
            }
            cardList.innerHTML = html;
        }

        function addNewCard() {
            const name = document.getElementById('newCardName').value.trim();
            const rate = parseFloat(document.getElementById('newCardRate').value);

            if (!name) {
                alert('Please enter a card name.');
                return;
            }

            if (isNaN(rate) || rate < 0) {
                alert('Please enter a valid cash back rate.');
                return;
            }

            cards[name] = rate / 100;
            renderCardList();
            populateCardSelect();

            document.getElementById('newCardName').value = '';
            document.getElementById('newCardRate').value = '';
        }

        function deleteCard(cardName) {
            if (Object.keys(cards).length <= 1) {
                alert('You must have at least one credit card.');
                return;
            }

            if (confirm('Delete "' + cardName + '"?')) {
                const firstCard = Object.keys(cards).find(key => key !== cardName);
                
                for (let i = 0; i < allEntries.length; i++) {
                    if (allEntries[i].card === cardName) {
                        allEntries[i].card = firstCard;
                    }
                    if (allEntries[i].shippingCard === cardName) {
                        allEntries[i].shippingCard = firstCard;
                    }
                }
                
                delete cards[cardName];
                
                renderCardList();
                populateCardSelect();
                filterEntries();
                updateDashboard();
            }
        }

        // Import/Export functions
        function exportCSV() {
            const headers = ['Date', 'Item', 'Purchase Card', 'Purchase Amount', 'Shipping Cost', 'Shipping Card', 'Incoming Tracking', 'Resold', 'Sale Price', 'Outgoing Tracking', 'Ship Date', 'Total Cash Back', 'Cash Profit', 'Total Profit'];
            const csvRows = [headers.join(',')];

            for (let i = 0; i < allEntries.length; i++) {
                const entry = allEntries[i];
                const metrics = calculateMetrics(entry);
                const row = [
                    entry.date,
                    '"' + entry.item.replace(/"/g, '""') + '"',
                    entry.card,
                    entry.amount,
                    entry.shippingCost || 0,
                    entry.shippingCard || entry.card,
                    entry.incomingTracking,
                    entry.resold ? 'Yes' : 'No',
                    entry.salePrice,
                    entry.outgoingTracking,
                    entry.outgoingDate,
                    metrics.cashBack.toFixed(2),
                    metrics.cashProfit.toFixed(2),
                    metrics.profit.toFixed(2)
                ];
                csvRows.push(row.join(','));
            }

            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'purchase_tracker_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n');
                    
                    allEntries = [];
                    entryCounter = 0;

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const values = line.split(',');
                        if (values.length < 4) continue;

                        const entry = {
                            id: ++entryCounter,
                            date: values[0] || '',
                            item: values[1].replace(/"/g, '') || '',
                            card: values[2] || Object.keys(cards)[0],
                            amount: parseFloat(values[3]) || 0,
                            shippingCost: parseFloat(values[4]) || 0,
                            shippingCard: values[5] || Object.keys(cards)[0],
                            incomingTracking: values[6] || '',
                            resold: values[7] === 'Yes',
                            salePrice: parseFloat(values[8]) || 0,
                            outgoingTracking: values[9] || '',
                            outgoingDate: values[10] || ''
                        };

                        if (!cards[entry.card]) {
                            entry.card = Object.keys(cards)[0];
                        }
                        if (!cards[entry.shippingCard]) {
                            entry.shippingCard = Object.keys(cards)[0];
                        }

                        allEntries.unshift(entry);
                    }

                    filterEntries();
                    updateDashboard();
                    alert('CSV imported successfully!');

                } catch (error) {
                    alert('Error importing CSV: ' + error.message);
                }
            };

            reader.readAsText(file);
            event.target.value = '';
        }

        // Event listeners
        document.addEventListener('click', function(event) {
            if (event.target.id === 'cardModal') {
                closeCardModal();
            }
            if (event.target.id === 'entryModal') {
                closeEntryModal();
            }
        });

        function createEntry(data) {
            const entry = {
                id: ++entryCounter,
                date: data.date || '',
                item: data.item || '',
                card: data.card || Object.keys(cards)[0],
                amount: data.amount || 0,
                shippingCost: data.shippingCost || 0,
                shippingCard: data.shippingCard || Object.keys(cards)[0],
                incomingTracking: data.incomingTracking || '',
                resold: data.resold || false,
                salePrice: data.salePrice || 0,
                outgoingTracking: data.outgoingTracking || '',
                outgoingDate: data.outgoingDate || ''
            };
            
            allEntries.unshift(entry);
            return entry;
        }

        // Initialize app
        function initializeApp() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
            
            // Load sample data
            for (let i = 0; i < sampleData.length; i++) {
                createEntry(sampleData[i]);
            }
            
            filterEntries();
            updateDashboard();
            
            // Focus password input on load
            setTimeout(() => {
                document.getElementById('passwordInput').focus();
            }, 100);
        }

        // Start the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>