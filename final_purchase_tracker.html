<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase & Resale Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        
        .button-container {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-export {
            background: #2196F3;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1800px;
            table-layout: fixed;
        }
        
        /* Fixed column widths for better alignment */
        th:nth-child(1), td:nth-child(1) { width: 120px; }
        th:nth-child(2), td:nth-child(2) { width: 160px; }
        th:nth-child(3), td:nth-child(3) { width: 150px; }
        th:nth-child(4), td:nth-child(4) { width: 90px; }
        th:nth-child(5), td:nth-child(5) { width: 150px; }
        th:nth-child(6), td:nth-child(6) { width: 80px; }
        th:nth-child(7), td:nth-child(7) { width: 180px; }
        th:nth-child(8), td:nth-child(8) { width: 110px; }
        th:nth-child(9), td:nth-child(9) { width: 120px; }
        th:nth-child(10), td:nth-child(10) { width: 80px; }
        th:nth-child(11), td:nth-child(11) { width: 90px; }
        th:nth-child(12), td:nth-child(12) { width: 180px; }
        th:nth-child(13), td:nth-child(13) { width: 110px; }
        th:nth-child(14), td:nth-child(14) { width: 120px; }
        th:nth-child(15), td:nth-child(15) { width: 90px; }
        th:nth-child(16), td:nth-child(16) { width: 90px; }
        th:nth-child(17), td:nth-child(17) { width: 80px; }
        
        th {
            background: #f8f9fa;
            color: #333;
            font-weight: bold;
            padding: 12px 8px;
            text-align: center;
            border-bottom: 2px solid #dee2e6;
            font-size: 12px;
            vertical-align: middle;
            white-space: nowrap;
        }
        
        td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            text-align: center;
            vertical-align: middle;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        input, select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 11px;
            text-align: center;
        }
        
        .date-input {
            width: 110px;
            min-width: 110px;
        }
        
        .currency-input {
            width: 80px;
            min-width: 80px;
            text-align: right;
        }
        
        .tracking-input {
            width: 130px;
            min-width: 130px;
            font-size: 10px;
        }
        
        .item-input {
            width: 150px;
            min-width: 150px;
            text-align: left;
        }
        
        .card-select {
            width: 140px;
            min-width: 140px;
            font-size: 10px;
        }
        
        .card-chase { background-color: #e3f2fd !important; }
        .card-wells { background-color: #f3e5f5 !important; }
        .card-farmers { background-color: #e8f5e8 !important; }
        .card-custom { background-color: #fff3e0 !important; }
        
        .profit-positive { color: #4caf50; font-weight: bold; }
        .profit-negative { color: #f44336; font-weight: bold; }
        
        .status-waiting { color: #ff9800; font-weight: bold; }
        .status-received { color: #4caf50; font-weight: bold; }
        .status-inflight { color: #f44336; font-weight: bold; }
        .status-delivered { color: #4caf50; font-weight: bold; }
        
        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        
        .delete-btn:hover {
            background: #d32f2f;
        }
        
        .track-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 9px;
            margin-left: 4px;
            white-space: nowrap;
            display: inline-block;
        }
        
        .track-btn:hover {
            background: #1976d2;
        }
        
        .tracking-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 4px;
        }
        
        .status-cell {
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            padding: 4px;
            white-space: nowrap;
        }
        
        #csvFileInput {
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
        }
        
        .modal h2 {
            margin-top: 0;
        }
        
        .modal-buttons {
            text-align: right;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            margin-left: 10px;
        }
        
        .card-list {
            margin: 15px 0;
        }
        
        .card-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .card-item:hover {
            background-color: #f8f9fa;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Credit Card Purchase & Resale Tracker</h1>
        
        <div class="summary-cards">
            <div class="summary-card">
                <h3>Total Purchases</h3>
                <p class="value" id="totalPurchases">$0.00</p>
            </div>
            <div class="summary-card">
                <h3>Total Cash Back</h3>
                <p class="value" id="totalCashBack">$0.00</p>
            </div>
            <div class="summary-card">
                <h3>Total Revenue</h3>
                <p class="value" id="totalRevenue">$0.00</p>
            </div>
            <div class="summary-card">
                <h3>Net Profit</h3>
                <p class="value" id="netProfit">$0.00</p>
            </div>
        </div>
        
        <div class="button-container">
            <button class="btn" onclick="addNewRow()">Add New Purchase</button>
            <button class="btn btn-secondary" onclick="openCardModal()">Manage Credit Cards</button>
            <button class="btn btn-export" onclick="exportData()">Export to CSV</button>
            <button class="btn btn-export" onclick="importData()">Import CSV</button>
        </div>
        
        <input type="file" id="csvFileInput" accept=".csv">
        
        <div class="table-container">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th>Purchase Date</th>
                        <th>Item Description</th>
                        <th>Credit Card</th>
                        <th>Purchase Amount</th>
                        <th>Cash Back Card</th>
                        <th>Cash Back $</th>
                        <th>Incoming Tracking</th>
                        <th>Incoming Status</th>
                        <th>Date Received</th>
                        <th>Resold?</th>
                        <th>Sale Price</th>
                        <th>Outgoing Tracking</th>
                        <th>Outgoing Status</th>
                        <th>Date Shipped</th>
                        <th>Gross Profit</th>
                        <th>Net Profit</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="dataBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Credit Card Management Modal -->
    <div id="cardModal" class="modal">
        <div class="modal-content">
            <h2>Manage Credit Cards</h2>
            
            <div class="card-list" id="cardList">
            </div>
            
            <h3>Add New Credit Card</h3>
            <div class="form-group">
                <label for="newCardName">Card Name:</label>
                <input type="text" id="newCardName" placeholder="e.g., Capital One Venture">
            </div>
            <div class="form-group">
                <label for="newCardRate">Cash Back Rate (%):</label>
                <input type="number" id="newCardRate" step="0.01" placeholder="e.g., 2.5">
            </div>
            
            <div class="modal-buttons">
                <button class="btn" onclick="addNewCard()">Add Card</button>
                <button class="btn btn-secondary" onclick="closeCardModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize variables
        let cashBackRates = {
            'Chase Reserve': 0.01,
            'Wells Fargo': 0.02,
            'Farmers Credit Union': 0.025
        };

        const initialData = [
            {
                purchaseDate: '2024-01-15',
                item: 'iPhone 15 Pro',
                card: 'Chase Reserve',
                purchaseAmount: 999.00,
                cashBackCard: 'Chase Reserve',
                incomingTracking: '1Z999AA1234567890',
                dateReceived: '2024-01-18',
                resold: 'Yes',
                salePrice: 1150.00,
                outgoingTracking: '1Z999BB9876543210',
                dateShipped: '2024-01-25'
            },
            {
                purchaseDate: '2024-01-20',
                item: 'Nike Air Jordan Retro',
                card: 'Wells Fargo',
                purchaseAmount: 180.00,
                cashBackCard: 'Wells Fargo',
                incomingTracking: '1Z888CC1122334455',
                dateReceived: '2024-01-23',
                resold: 'Yes',
                salePrice: 220.00,
                outgoingTracking: '1Z777DD5544332211',
                dateShipped: '2024-01-28'
            },
            {
                purchaseDate: '2024-02-01',
                item: 'MacBook Air M3',
                card: 'Farmers Credit Union',
                purchaseAmount: 1299.00,
                cashBackCard: 'Farmers Credit Union',
                incomingTracking: '1Z555EE7788990011',
                dateReceived: '2024-02-04',
                resold: 'Yes',
                salePrice: 1450.00,
                outgoingTracking: '1Z444FF1100998877',
                dateShipped: '2024-02-08'
            },
            {
                purchaseDate: '2024-02-10',
                item: 'Sony WH-1000XM5 Headphones',
                card: 'Chase Reserve',
                purchaseAmount: 349.99,
                cashBackCard: 'Chase Reserve',
                incomingTracking: '1Z333GG2233445566',
                dateReceived: '2024-02-13',
                resold: 'No',
                salePrice: 0,
                outgoingTracking: '',
                dateShipped: ''
            },
            {
                purchaseDate: '2024-02-15',
                item: 'Apple Watch Series 9',
                card: 'Wells Fargo',
                purchaseAmount: 429.00,
                cashBackCard: 'Wells Fargo',
                incomingTracking: '1Z222HH9988776655',
                dateReceived: '',
                resold: 'No',
                salePrice: 0,
                outgoingTracking: '',
                dateShipped: ''
            },
            {
                purchaseDate: '2024-02-20',
                item: 'Dell XPS 13 Laptop',
                card: 'Farmers Credit Union',
                purchaseAmount: 899.00,
                cashBackCard: 'Farmers Credit Union',
                incomingTracking: '1Z111II5566778899',
                dateReceived: '2024-02-23',
                resold: 'Yes',
                salePrice: 1050.00,
                outgoingTracking: '1Z000JJ3344556677',
                dateShipped: '2024-02-27'
            }
        ];

        // In-memory data storage
        let trackerData = null;

        // Currency formatting functions
        function formatCurrencyDisplay(value) {
            if (!value || value === 0) return '';
            const num = parseFloat(value);
            if (isNaN(num)) return '';
            return '$' + num.toFixed(2);
        }

        function handleCurrencyInput(input) {
            let value = input.value;
            
            // Remove dollar sign if present
            value = value.replace('$', '');
            
            // Remove any non-numeric characters except decimal point
            value = value.replace(/[^\d.]/g, '');
            
            // Ensure only one decimal point
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // Limit to 2 decimal places
            if (parts[1] && parts[1].length > 2) {
                value = parts[0] + '.' + parts[1].substring(0, 2);
            }
            
            // Add dollar sign and format
            if (value && !isNaN(parseFloat(value))) {
                input.value = '$' + parseFloat(value).toFixed(2);
            } else if (value === '') {
                input.value = '';
            }
        }

        function getCurrencyValue(input) {
            if (!input || !input.value) return 0;
            const value = input.value.replace('$', '');
            return parseFloat(value) || 0;
        }

        // Utility functions
        function getCardClass(card) {
            const classes = {
                'Chase Reserve': 'card-chase',
                'Wells Fargo': 'card-wells',
                'Farmers Credit Union': 'card-farmers'
            };
            return classes[card] || 'card-custom';
        }

        function createCardOptions(selectedCard = 'Chase Reserve') {
            const options = [];
            for (const [cardName, rate] of Object.entries(cashBackRates)) {
                const percentage = (rate * 100).toFixed(1);
                options.push({
                    value: cardName,
                    text: `${cardName} (${percentage}%)`
                });
            }
            
            return options.map(option => 
                `<option value="${option.value}" ${option.value === selectedCard ? 'selected' : ''}>${option.text}</option>`
            ).join('');
        }

        // Credit Card Management
        function openCardModal() {
            document.getElementById('cardModal').style.display = 'block';
            updateCardList();
        }

        function closeCardModal() {
            document.getElementById('cardModal').style.display = 'none';
        }

        function updateCardList() {
            const cardList = document.getElementById('cardList');
            cardList.innerHTML = '';
            
            for (const [cardName, rate] of Object.entries(cashBackRates)) {
                const cardItem = document.createElement('div');
                cardItem.className = 'card-item';
                cardItem.innerHTML = `
                    <span>${cardName} - ${(rate * 100).toFixed(1)}%</span>
                    <button class="btn btn-danger delete-btn" onclick="deleteCard('${cardName}')">Delete</button>
                `;
                cardList.appendChild(cardItem);
            }
        }

        function addNewCard() {
            const name = document.getElementById('newCardName').value.trim();
            const rate = parseFloat(document.getElementById('newCardRate').value);
            
            if (!name || isNaN(rate) || rate < 0) {
                alert('Please enter a valid card name and rate.');
                return;
            }
            
            cashBackRates[name] = rate / 100;
            updateCardList();
            updateAllCardSelects();
            
            document.getElementById('newCardName').value = '';
            document.getElementById('newCardRate').value = '';
            
            saveDataToStorage();
        }

        function deleteCard(cardName) {
            if (Object.keys(cashBackRates).length <= 1) {
                alert('You must have at least one credit card.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${cardName}?`)) {
                delete cashBackRates[cardName];
                updateCardList();
                updateAllCardSelects();
                saveDataToStorage();
            }
        }

        function updateAllCardSelects() {
            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                if (select.onchange === handleCardChange || select.onchange === handleChange) {
                    const currentValue = select.value;
                    select.innerHTML = createCardOptions(currentValue);
                    if (!cashBackRates[currentValue]) {
                        select.value = Object.keys(cashBackRates)[0];
                        if (select.onchange === handleCardChange) {
                            handleCardChange(select);
                        } else {
                            handleChange(select);
                        }
                    }
                }
            });
        }

        // Tracking functions
        function trackPackage(trackingNumber, type) {
            if (!trackingNumber) {
                alert('No tracking number available');
                return;
            }
            
            const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(trackingNumber + ' tracking')}`;
            window.open(searchUrl, '_blank');
        }

        function updateTrackingStatus(element, trackingNumber) {
            const statusCell = element.closest('tr').querySelector('.tracking-status');
            if (!trackingNumber) {
                statusCell.textContent = 'No Tracking';
                statusCell.className = 'tracking-status status-cell';
                return;
            }
            
            const statuses = ['Waiting Arrival', 'In Transit', 'Received'];
            const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
            
            statusCell.textContent = randomStatus;
            statusCell.className = `tracking-status status-cell status-${randomStatus.toLowerCase().replace(' ', '')}`;
        }

        function updateOutgoingStatus(element, trackingNumber) {
            const statusCell = element.closest('tr').querySelector('.outgoing-status');
            if (!trackingNumber) {
                statusCell.textContent = 'Not Shipped';
                statusCell.className = 'outgoing-status status-cell';
                return;
            }
            
            const statuses = ['In Flight', 'Delivered'];
            const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
            
            statusCell.textContent = randomStatus;
            statusCell.className = `outgoing-status status-cell status-${randomStatus.toLowerCase().replace(' ', '')}`;
        }

        // Data persistence functions
        function saveDataToStorage() {
            try {
                const rows = document.querySelectorAll('#dataBody tr');
                const data = [];
                
                rows.forEach(row => {
                    if (row.cells && row.cells.length >= 17) {
                        const rowData = {
                            purchaseDate: row.cells[0].querySelector('input')?.value || '',
                            item: row.cells[1].querySelector('input')?.value || '',
                            card: row.cells[2].querySelector('select')?.value || Object.keys(cashBackRates)[0],
                            purchaseAmount: getCurrencyValue(row.cells[3].querySelector('input')),
                            cashBackCard: row.cells[4].querySelector('select')?.value || Object.keys(cashBackRates)[0],
                            incomingTracking: row.cells[6].querySelector('input')?.value || '',
                            dateReceived: row.cells[8].querySelector('input')?.value || '',
                            resold: row.cells[9].querySelector('select')?.value || 'No',
                            salePrice: getCurrencyValue(row.cells[10].querySelector('input')),
                            outgoingTracking: row.cells[11].querySelector('input')?.value || '',
                            dateShipped: row.cells[13].querySelector('input')?.value || ''
                        };
                        data.push(rowData);
                    }
                });
                
                trackerData = {
                    purchases: data,
                    creditCards: cashBackRates
                };
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        function loadDataFromStorage() {
            try {
                if (trackerData) {
                    if (trackerData.creditCards) {
                        cashBackRates = trackerData.creditCards;
                    }
                    if (trackerData.purchases && Array.isArray(trackerData.purchases) && trackerData.purchases.length > 0) {
                        return trackerData.purchases;
                    }
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
            return initialData;
        }

        // Row management functions
        function createRow(data = {}) {
            const row = document.createElement('tr');
            row.className = getCardClass(data.card || Object.keys(cashBackRates)[0]);
            
            row.innerHTML = `
                <td><input type="date" class="date-input" value="${data.purchaseDate || ''}" onchange="handleChange(this)"></td>
                <td><input type="text" class="item-input" placeholder="Item description" value="${data.item || ''}" onchange="handleChange(this)"></td>
                <td>
                    <select class="card-select" onchange="handleCardChange(this)">
                        ${createCardOptions(data.card)}
                    </select>
                </td>
                <td><input type="text" class="currency-input" placeholder="$0.00" value="${data.purchaseAmount ? formatCurrencyDisplay(data.purchaseAmount) : ''}" onchange="handleChange(this)" oninput="handleCurrencyInput(this)"></td>
                <td>
                    <select class="card-select" onchange="handleChange(this)">
                        ${createCardOptions(data.cashBackCard || data.card)}
                    </select>
                </td>
                <td class="cash-back-display">$0.00</td>
                <td class="tracking-cell">
                    <input type="text" class="tracking-input" placeholder="Tracking #" value="${data.incomingTracking || ''}" onchange="handleTrackingChange(this, 'incoming')">
                    <button class="track-btn" onclick="trackPackage('${data.incomingTracking || ''}', 'incoming')">Track</button>
                </td>
                <td class="tracking-status status-cell">No Tracking</td>
                <td><input type="date" class="date-input" value="${data.dateReceived || ''}" onchange="handleChange(this)"></td>
                <td>
                    <select onchange="handleChange(this)">
                        <option value="No" ${data.resold === 'No' ? 'selected' : ''}>No</option>
                        <option value="Yes" ${data.resold === 'Yes' ? 'selected' : ''}>Yes</option>
                    </select>
                </td>
                <td><input type="text" class="currency-input" placeholder="$0.00" value="${data.salePrice ? formatCurrencyDisplay(data.salePrice) : ''}" onchange="handleChange(this)" oninput="handleCurrencyInput(this)"></td>
                <td class="tracking-cell">
                    <input type="text" class="tracking-input" placeholder="Tracking #" value="${data.outgoingTracking || ''}" onchange="handleTrackingChange(this, 'outgoing')">
                    <button class="track-btn" onclick="trackPackage('${data.outgoingTracking || ''}', 'outgoing')">Track</button>
                </td>
                <td class="outgoing-status status-cell">Not Shipped</td>
                <td><input type="date" class="date-input" value="${data.dateShipped || ''}" onchange="handleChange(this)"></td>
                <td class="gross-profit-display">$0.00</td>
                <td class="net-profit-display">$0.00</td>
                <td><button class="delete-btn" onclick="removeRow(this)">Delete</button></td>
            `;
            
            return row;
        }

        function addNewRow() {
            const tbody = document.getElementById('dataBody');
            const newRow = createRow();
            tbody.appendChild(newRow);
            calculateRow(newRow);
            updateTotals();
            saveDataToStorage();
        }

        function removeRow(button) {
            if (confirm('Are you sure you want to delete this entry?')) {
                button.closest('tr').remove();
                updateTotals();
                saveDataToStorage();
            }
        }

        // Event handlers
        function handleChange(element) {
            calculateRow(element.closest('tr'));
            updateTotals();
            saveDataToStorage();
        }

        function handleCardChange(element) {
            const row = element.closest('tr');
            row.className = getCardClass(element.value);
            calculateRow(row);
            updateTotals();
            saveDataToStorage();
        }

        function handleTrackingChange(element, type) {
            const trackingNumber = element.value;
            const trackBtn = element.nextElementSibling;
            trackBtn.onclick = () => trackPackage(trackingNumber, type);
            
            if (type === 'incoming') {
                updateTrackingStatus(element, trackingNumber);
            } else {
                updateOutgoingStatus(element, trackingNumber);
            }
            
            saveDataToStorage();
        }

        // Calculation functions
        function calculateRow(row) {
            if (!row || !row.cells || row.cells.length < 16) return;
            
            try {
                const purchaseAmount = getCurrencyValue(row.cells